<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analítico de Excel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Plugin Datalabels -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase SDKs (v9 compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .drop-zone { border: 2px dashed #cbd5e1; transition: all 0.3s ease; }
        .drop-zone.active { border-color: #3b82f6; background-color: #eff6ff; }
        
        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }
        .report-item-card { transition: all 0.2s ease; }
        .report-item-card.active { border-color: #3b82f6; background-color: #eff6ff; }
        .file-item-active { background-color: #eff6ff !important; border-color: #3b82f6 !important; color: #1d4ed8 !important; font-weight: 700 !important; }

        .table-filter-input {
            width: 100%; font-size: 10px; padding: 2px 6px; border: 1px solid #e2e8f0; border-radius: 4px; font-weight: normal; color: #475569; outline: none; transition: border-color 0.2s;
        }
        .table-filter-input:focus { border-color: #3b82f6; background-color: #fff; }

        .nav-link { transition: all 0.2s; position: relative; }
        .nav-link.active { color: #2563eb; }
        .nav-link.active::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 2px; background: #2563eb; border-radius: 2px; }

        .clickable-row-cell { cursor: pointer; transition: background-color 0.2s; }
        .clickable-row-cell:hover { background-color: #f8fafc; }

        #sidebar { transition: all 0.3s ease-in-out; }
        #dashboardView, #reportView, #dashboardBottomView { transition: all 0.3s ease-in-out; }
        #syncIndicator { transition: opacity 0.3s; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen font-sans">

    <!-- Fallback de input de ficheiros -->
    <input type="file" id="folderInputFallback" webkitdirectory directory multiple class="hidden" onchange="handleFallbackFolder(this)">
    <!-- Input para Importação de Ações -->
    <input type="file" id="importActionsInput" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleActionsImport(this)">

    <div id="app" class="max-w-[1400px] mx-auto px-4 py-6">
        <header class="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div class="flex flex-col gap-1">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-200 rounded-lg transition text-slate-500" title="Recolher/Expandir Barra Lateral">
                        <i id="toggleSidebarIcon" data-lucide="panel-left-close" class="w-5 h-5"></i>
                    </button>
                    <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                        <i data-lucide="layout-dashboard" class="text-blue-600"></i>
                        Dashboard Analítico
                    </h1>
                    <div id="lastUpdateTag" class="hidden flex items-center gap-1.5 px-2.5 py-1 bg-white text-slate-500 text-[10px] font-semibold rounded-full border border-slate-200 shadow-sm animate-in fade-in slide-in-from-left-2 duration-500">
                        <i data-lucide="clock" class="w-3 h-3 text-blue-500"></i>
                        <span id="lastUpdateText"></span>
                    </div>
                    <!-- Sync Badge -->
                    <div id="syncIndicator" class="opacity-0 flex items-center gap-1.5 px-2.5 py-1 bg-emerald-50 text-emerald-600 text-[10px] font-bold rounded-full border border-emerald-100 shadow-sm">
                        <i data-lucide="cloud-check" class="w-3 h-3"></i>
                        <span>Cloud Synced</span>
                    </div>
                </div>
                
                <!-- Navegação Principal -->
                <nav class="flex items-center gap-6 mt-2 ml-10">
                    <button onclick="switchView('dashboard')" id="nav-dashboard" class="nav-link active text-sm font-bold text-slate-500 hover:text-slate-800 flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Dashboard
                    </button>
                    <button onclick="switchView('report')" id="nav-report" class="nav-link text-sm font-bold text-slate-500 hover:text-slate-800 flex items-center gap-2">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Report
                    </button>
                </nav>
            </div>
            
            <div class="flex items-center gap-3">
                <div id="fileInfo" class="hidden text-sm px-4 py-2 bg-blue-50 text-blue-700 rounded-lg flex items-center gap-3 border border-blue-100 shadow-sm">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                    <span id="fileName" class="truncate font-medium max-w-[200px]"></span>
                    <button onclick="resetApp()" class="text-blue-400 hover:text-red-500 transition p-1 hover:bg-white rounded-full">
                        <i data-lucide="x" class="w-3.5 h-3.5"></i>
                    </button>
                </div>
            </div>
        </header>

        <div id="main-content" class="grid grid-cols-1 xl:grid-cols-12 gap-6">
            <!-- Sidebar -->
            <div id="sidebar" class="xl:col-span-3 space-y-6 shrink-0">
                <section class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="folder-search" class="w-4 h-4 text-orange-500"></i> Pasta Local (API)
                    </h2>
                    <div id="dirControls">
                        <button id="mainFolderBtn" onclick="selectLocalDirectory()" class="w-full py-3 px-4 bg-orange-50 text-orange-700 border border-orange-200 rounded-lg text-xs font-bold hover:bg-orange-100 transition flex items-center justify-center gap-2">
                            <i data-lucide="folder-plus" class="w-4 h-4"></i> Monitorizar Pasta Local
                        </button>
                    </div>
                    <div id="dirFileList" class="hidden mt-4 space-y-2 max-h-48 overflow-y-auto custom-scrollbar p-1"></div>
                    <button id="refreshDirBtn" onclick="scanDirectory()" class="hidden mt-3 w-full py-2 bg-slate-100 text-slate-600 rounded-lg text-[10px] font-bold hover:bg-slate-200 transition flex items-center justify-center gap-2">
                        <i data-lucide="rotate-cw" class="w-3 h-3"></i> Atualizar
                    </button>
                </section>

                <section id="statusSection" class="hidden bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                    <h2 class="text-sm font-semibold mb-3 flex items-center gap-2 text-slate-700">
                        <i data-lucide="check-circle-2" class="text-emerald-500"></i> Análise Concluída
                    </h2>
                    <div id="detectedCols" class="space-y-1 mb-4 flex flex-wrap gap-1"></div>
                    <button onclick="runDashboardAnalysis()" class="mt-2 w-full py-2 bg-slate-100 text-slate-600 rounded-lg text-xs font-medium hover:bg-slate-200 transition">Recalcular</button>
                </section>

                <!-- Quadro de Notas -->
                <section id="section-notes" class="hidden bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-[350px] border-l-4 border-l-yellow-400">
                    <h2 class="text-base font-semibold mb-2 flex items-center gap-2 text-slate-800">
                        <i data-lucide="clipboard-edit" class="w-4 h-4 text-yellow-500"></i> Notas
                    </h2>
                    <textarea id="notesField" class="grow w-full p-3 text-sm border border-slate-200 rounded-lg bg-yellow-50/30 focus:ring-2 focus:ring-yellow-400 resize-none custom-scrollbar" placeholder="Observações..."></textarea>
                </section>
            </div>

            <!-- Dashboard Charts View -->
            <div id="dashboardView" class="xl:col-span-9 space-y-6">
                <div id="emptyState" class="bg-white rounded-xl border-2 border-dashed border-slate-200 h-[500px] flex flex-col items-center justify-center text-slate-400">
                    <i data-lucide="bar-chart-big" class="w-16 h-16 mb-4 text-slate-300"></i>
                    <p class="text-lg font-medium text-slate-500">Aguardando dados</p>
                </div>

                <div id="dashboardChartsContainer" class="hidden space-y-6">
                    <section id="section-timeline" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between mb-4 gap-4">
                            <h2 class="text-base font-semibold flex items-center gap-2">
                                <i data-lucide="line-chart" class="w-4 h-4 text-blue-500"></i> Volume Horário por Data e Estado
                            </h2>
                            <div class="flex items-center gap-2 text-sm">
                                <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-md border border-slate-200 mr-2">
                                    <i data-lucide="filter" class="w-3 h-3 text-slate-400 ml-1"></i>
                                    <select id="lineViewSelector" class="bg-transparent border-0 focus:ring-0 text-[10px] font-bold text-slate-600 cursor-pointer p-1" onchange="refreshDashboard()">
                                        <option value="all">Visão Geral (Tudo)</option>
                                        <option value="wms">WMS (Entradas)</option>
                                        <option value="protheus">Protheus (Saídas)</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-1 bg-slate-100 p-1 rounded-md border border-slate-200">
                                    <input type="date" id="dateStart" class="bg-transparent border-0 focus:ring-0 text-xs p-1" onchange="refreshDashboard()">
                                    <span class="text-slate-400">-</span>
                                    <input type="date" id="dateEnd" class="bg-transparent border-0 focus:ring-0 text-xs p-1" onchange="refreshDashboard()">
                                </div>
                            </div>
                        </div>
                        <div class="h-[250px] relative"><canvas id="lineChartCanvas"></canvas></div>
                    </section>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <section id="section-bar" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                                <i data-lucide="arrow-left-right" class="w-4 h-4 text-indigo-500"></i> Comparativo de Entrada e Saída
                            </h2>
                            <div class="h-[300px] relative"><canvas id="barChartCanvas"></canvas></div>
                        </section>

                        <section id="section-doughnut" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                                <i data-lucide="pie-chart" class="w-4 h-4 text-emerald-500"></i> Distribuição de Estados
                            </h2>
                            <div class="h-[300px] relative flex items-center justify-center">
                                <canvas id="doughnutChartCanvas"></canvas>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- Report View -->
            <div id="reportView" class="hidden xl:col-span-9 space-y-6">
                <section class="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="scroll-text" class="text-blue-600"></i> Relatório de Ações
                            </h2>
                            <p class="text-sm text-slate-500">Gestão e acompanhamento de ações</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="exportActionsToCSV()" class="px-4 py-2.5 bg-emerald-50 text-emerald-600 border border-emerald-200 rounded-lg text-sm font-bold hover:bg-emerald-100 transition flex items-center gap-2 active:scale-95">
                                <i data-lucide="download" class="w-4 h-4"></i> Exportar
                            </button>
                            <button onclick="document.getElementById('importActionsInput').click()" class="px-4 py-2.5 bg-indigo-50 text-indigo-600 border border-indigo-200 rounded-lg text-sm font-bold hover:bg-indigo-100 transition flex items-center gap-2 active:scale-95">
                                <i data-lucide="file-up" class="w-4 h-4"></i> Importar Planilha
                            </button>
                            <button onclick="openActionModal()" class="px-6 py-2.5 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-100 flex items-center gap-2 active:scale-95">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Registar Nova Ação
                            </button>
                        </div>
                    </div>

                    <!-- Filtros Relatório -->
                    <div class="mb-6 p-5 bg-slate-50 border border-slate-200 rounded-xl shadow-inner">
                        <div class="flex items-center gap-2 mb-3">
                            <i data-lucide="filter" class="w-4 h-4 text-slate-400"></i>
                            <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Filtrar Relatórios</h3>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Data Registro</label>
                                <input type="date" id="rep-filter-date" oninput="renderActionsTable()" class="w-full p-2 text-xs border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Prioridade</label>
                                <input type="text" id="rep-filter-priority" placeholder="Filtrar ID..." oninput="renderActionsTable()" class="w-full p-2 text-xs border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Sistema</label>
                                <select id="rep-filter-system" onchange="renderActionsTable()" class="w-full p-2 text-xs border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Todos</option>
                                    <option value="Protheus">Protheus</option>
                                    <option value="WMS">WMS</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Estado</label>
                                <select id="rep-filter-status" onchange="renderActionsTable()" class="w-full p-2 text-xs border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                                    <option value="">Todos</option>
                                    <option value="Não iniciado">Não iniciado</option>
                                    <option value="Em analise">Em analise</option>
                                    <option value="Em andamento">Em andamento</option>
                                    <option value="Em acompanhamento">Em acompanhamento</option>
                                    <option value="Em teste">Em teste</option>
                                    <option value="Concluído">Concluído</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Prazo (Conclusão)</label>
                                <input type="date" id="rep-filter-deadline" oninput="renderActionsTable()" class="w-full p-2 text-xs border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-full">
                                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Registos</label>
                                    <select id="repTableLimit" onchange="renderActionsTable()" class="w-full p-2 text-xs border border-slate-200 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                        <option value="10">10 itens</option>
                                        <option value="25">25 itens</option>
                                        <option value="50">50 itens</option>
                                        <option value="100">100 itens</option>
                                        <option value="all">Ver Tudo</option>
                                    </select>
                                </div>
                                <button onclick="clearReportFilters()" class="w-full py-2 bg-white border border-slate-200 text-[10px] font-bold text-slate-600 rounded-lg hover:bg-slate-100 transition flex items-center justify-center gap-1 active:scale-95 h-[34px] mt-4">
                                    <i data-lucide="filter-x" class="w-3.5 h-3.5 text-red-500"></i> Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto border rounded-xl">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-600">
                                <tr>
                                    <th class="px-6 py-4 font-bold border-b">Data</th>
                                    <th class="px-6 py-4 font-bold border-b text-center">ID Prioridade</th>
                                    <th class="px-6 py-4 font-bold border-b">Sistema</th>
                                    <th class="px-6 py-4 font-bold border-b">Responsável</th>
                                    <th class="px-6 py-4 font-bold border-b">Ação / Solução</th>
                                    <th class="px-6 py-4 font-bold border-b text-center">Prazo</th>
                                    <th class="px-6 py-4 font-bold border-b text-center">Estado</th>
                                    <th class="px-6 py-4 font-bold border-b text-right">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="actionsTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                    <div id="actionsEmptyState" class="py-20 flex flex-col items-center justify-center text-slate-400">
                        <i data-lucide="clipboard-list" class="w-12 h-12 mb-2 opacity-20"></i>
                        <p class="text-sm">Nenhuma ação encontrada.</p>
                    </div>
                </section>
            </div>

            <!-- Dashboard Bottom View (Tabela em Largura Total) -->
            <div id="dashboardBottomView" class="hidden xl:col-span-12">
                <section id="section-table" class="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-[550px]">
                    <div class="flex items-center justify-between mb-4 shrink-0">
                        <div class="flex items-center gap-4">
                            <h2 id="balanceTableTitle" class="text-base font-semibold flex items-center gap-2">
                                <i data-lucide="arrow-right-left" class="w-4 h-4 text-orange-500"></i> Entradas e Saídas - ASN
                            </h2>
                            <div class="flex items-center gap-2 bg-slate-50 border border-slate-200 px-2 py-1 rounded-lg">
                                <label for="tableLimit" class="text-[10px] font-bold text-slate-400 uppercase">Mostrar:</label>
                                <select id="tableLimit" onchange="renderBalanceTable()" class="bg-transparent border-0 focus:ring-0 text-xs font-bold text-slate-600 cursor-pointer">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="all">Tudo</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="exportTableToCSV()" class="text-[10px] bg-emerald-50 text-emerald-600 hover:bg-emerald-100 border border-emerald-200 px-3 py-1.5 rounded-lg font-bold flex items-center gap-2 transition shadow-sm active:scale-95">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i> Exportar CSV
                        </button>
                    </div>
                    <div class="overflow-auto custom-scrollbar grow border rounded-lg">
                        <table id="asnTable" class="w-full text-sm text-left relative">
                            <thead class="bg-slate-50 text-slate-600 sticky top-0 shadow-sm z-10">
                                <tr>
                                    <th class="px-4 py-2 font-semibold border-b">Data</th>
                                    <th id="idColumnHeader" class="px-4 py-2 font-semibold border-b">ASN (ID)</th>
                                    <th class="px-4 py-2 font-semibold border-b text-center text-green-600">Entradas (OK)</th>
                                    <th class="px-4 py-2 font-semibold border-b text-center text-blue-600">Saídas (OK)</th>
                                    <th class="px-4 py-2 font-semibold border-b text-center bg-slate-100">Diferença (OK)</th>
                                    <th class="px-4 py-2 font-semibold border-b text-center text-red-500">Estado de Erro</th>
                                    <th class="px-4 py-2 font-semibold border-b text-center text-slate-500">Motivo / Análise</th>
                                    <th class="px-4 py-2 font-semibold border-b text-center text-slate-400">Ação</th>
                                </tr>
                                <tr class="bg-white">
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-balance-date" class="table-filter-input text-center" placeholder="Filtro Data..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-id" class="table-filter-input" placeholder="Pesquisar ID..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-entradas" class="table-filter-input text-center" placeholder="Filtro..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-saidas" class="table-filter-input text-center" placeholder="Filtro..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-dif" class="table-filter-input text-center" placeholder="Filtro..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-status" class="table-filter-input text-center" placeholder="Filtrar estado..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"><input type="text" id="filter-motivo" class="table-filter-input text-center" placeholder="Filtrar motivo..." oninput="renderBalanceTable()"></th>
                                    <th class="px-2 py-1 border-b"></th>
                                </tr>
                            </thead>
                            <tbody id="balanceTableBody" class="divide-y divide-slate-100"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes -->
    <div id="detailsModal" class="hidden fixed inset-0 z-[130] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg animate-in fade-in zoom-in duration-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-indigo-50 flex items-center justify-between">
                <h3 class="text-lg font-bold text-indigo-900 flex items-center gap-2">
                    <i data-lucide="info" class="text-indigo-600"></i> Detalhes da Ação
                </h3>
                <button onclick="closeDetailsModal()" class="text-indigo-400 hover:text-indigo-600 transition"><i data-lucide="x"></i></button>
            </div>
            <div class="p-8 space-y-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Título</label>
                    <div id="detTitle" class="text-lg font-bold text-slate-800 border-b border-slate-100 pb-2"></div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Sistema</label>
                        <div id="detSystem" class="text-sm font-semibold px-2 py-1 rounded bg-slate-100 w-fit text-indigo-700"></div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">ID Ref.</label>
                        <div id="detRef" class="text-sm font-mono text-slate-600"></div>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">ID Prioridade</label>
                    <div id="detPriority" class="text-sm font-bold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded border border-indigo-100 w-fit"></div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Descrição / Ação</label>
                    <div id="detDesc" class="text-sm text-slate-600 leading-relaxed bg-slate-50 p-4 rounded-lg border border-slate-100"></div>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-emerald-500 uppercase tracking-widest mb-1 flex items-center gap-1">
                        <i data-lucide="check-circle" class="w-3 h-3"></i> Solução / Resolução
                    </label>
                    <div id="detResolution" class="text-sm text-emerald-700 leading-relaxed bg-emerald-50 p-4 rounded-lg border border-emerald-100 font-medium"></div>
                </div>
            </div>
            <div class="p-6 bg-slate-50 flex items-center justify-end">
                <button onclick="closeDetailsModal()" class="px-8 py-2 bg-slate-800 text-white text-sm font-bold rounded-lg hover:bg-slate-900 transition">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Registo -->
    <div id="actionModal" class="hidden fixed inset-0 z-[120] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xl max-h-[95vh] flex flex-col animate-in fade-in zoom-in duration-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex items-center justify-between shrink-0">
                <h3 id="actionModalTitle" class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="plus-square" class="text-blue-600"></i> Novo Registo de Ação
                </h3>
                <button onclick="closeActionModal()" class="text-slate-400 hover:text-slate-600 transition"><i data-lucide="x"></i></button>
            </div>
            <form id="actionForm" onsubmit="saveAction(event)" class="p-6 space-y-4 overflow-y-auto custom-scrollbar grow">
                <input type="hidden" id="actId">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Título da Ação</label>
                        <input type="text" id="actTitle" required placeholder="Ex: Correção de ASN Pendente" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs font-bold text-indigo-400 uppercase mb-1">ID Prioridade (Alfanumérico)</label>
                        <input type="text" id="actPriority" placeholder="Ex: P1-A20" class="w-full p-2.5 text-sm border border-indigo-100 rounded-lg bg-indigo-50/30 focus:ring-2 focus:ring-indigo-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data da Ação</label>
                        <input type="date" id="actDate" required class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">ID Referência (ASN/OEXP)</label>
                        <input type="text" id="actRef" placeholder="Ex: 12345" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Sistema Envolvido</label>
                        <select id="actSystem" required class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="" disabled selected>Escolha o sistema...</option>
                            <option value="Protheus">Protheus</option>
                            <option value="WMS">WMS</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Data de Conclusão (Prazo)</label>
                        <input type="date" id="actDeadline" required class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Responsável</label>
                    <input type="text" id="actUser" required placeholder="Nome do colaborador" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Estado</label>
                    <select id="actStatus" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="Não iniciado">Não iniciado</option>
                        <option value="Em analise">Em analise</option>
                        <option value="Em andamento">Em andamento</option>
                        <option value="Em acompanhamento">Em acompanhamento</option>
                        <option value="Em teste">Em teste</option>
                        <option value="Concluído">Concluído</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Descrição da Ação</label>
                    <textarea id="actDesc" required rows="2" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-blue-500 outline-none resize-none" placeholder="Descreva os detalhes da intervenção..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Solução / Resolução</label>
                    <textarea id="actResolution" rows="2" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-emerald-500 outline-none resize-none" placeholder="Qual foi a solução final ou resolução aplicada?"></textarea>
                </div>
            </form>
            <div class="p-6 border-t border-slate-100 bg-slate-50 flex items-center justify-end gap-3 shrink-0">
                <button type="button" onclick="closeActionModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition">Descartar</button>
                <button type="submit" form="actionForm" class="px-8 py-2 bg-blue-600 text-white text-sm font-bold rounded-lg hover:bg-blue-700 shadow-lg shadow-blue-100 transition flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Registo
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Evidência Atualizado -->
    <div id="evidenceModal" class="hidden fixed inset-0 z-[110] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md animate-in fade-in zoom-in duration-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex items-center justify-between">
                <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                    <i data-lucide="shield-check" class="text-indigo-500"></i> Evidenciar Análise
                </h3>
                <button onclick="closeEvidenceModal()" class="text-slate-400 hover:text-slate-600 transition"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">ID Selecionado</label>
                    <div id="evidenceTargetId" class="text-sm font-mono bg-slate-100 p-2 rounded border border-slate-200 text-slate-700"></div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Estado da Análise</label>
                    <select id="evidenceStatus" class="w-full p-2.5 text-sm border border-slate-200 rounded-lg bg-slate-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="Processado com sucesso">Processado com sucesso</option>
                        <option value="Recebimento não finalizado">Recebimento não finalizado</option>
                        <option value="Item aguardando CQ">Item aguardando CQ</option>
                        <option value="Saldo insuficiente em estoque">Saldo insuficiente em estoque</option>
                        <option value="Saldo indisponível no Armazém Orig.02">Saldo indisponível no Armazém Orig.02</option>
                        <option value="Alguns itens processados; outros pendentes (Acompanhar)">Alguns itens processados; outros pendentes (Acompanhar)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Nota de Evidência / Motivo</label>
                    <textarea id="evidenceNote" class="w-full h-32 p-3 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none outline-none bg-slate-50 transition-all" placeholder="Escreva o motivo pelo qual este registro está em análise..."></textarea>
                </div>
                
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-100 flex items-center gap-3">
                    <input type="checkbox" id="evidenceCompleted" class="w-4 h-4 text-indigo-600 focus:ring-indigo-500 border-slate-300 rounded cursor-pointer">
                    <label for="evidenceCompleted" class="text-sm font-bold text-indigo-900 cursor-pointer">Marcar como Concluído</label>
                </div>
                <p class="text-[10px] text-slate-400 italic">* Registos concluídos deixam de ser exibidos na tabela de divergências.</p>
            </div>
            <div class="p-6 bg-slate-50 flex items-center justify-end gap-3">
                <button onclick="closeEvidenceModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition">Cancelar</button>
                <button onclick="saveEvidence()" class="px-6 py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition flex items-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Guardar Alteração
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl translate-y-24 opacity-0 transition-all duration-300 z-50 text-sm font-medium flex items-center gap-2"></div>

    <script>
        // --- Configuração Firebase ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA00vCKMI2yTqKMQ0LXtBYzv29p1WaKQqg",
            authDomain: "ntegracoesacomp.firebaseapp.com",
            projectId: "ntegracoesacomp",
            storageBucket: "ntegracoesacomp.firebasestorage.app",
            messagingSenderId: "557779665159",
            appId: "1:557779665159:web:27e81f752ab6403b8fc5a2",
            measurementId: "G-7768LKSBT9"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ntegracoesacomp';
        const fbApp = firebase.initializeApp(firebaseConfig);
        const db = fbApp.firestore();
        const auth = fbApp.auth();

        Chart.register(ChartDataLabels);

        let rawData = [];
        let headers = [];
        let currentFileName = '';
        let directoryHandle = null; 
        let analysisEvidences = {}; 
        let currentEvidenceId = null;
        let registeredActions = []; 
        let firebaseUser = null;

        let lineChart = null;
        let barChart = null;
        let doughnutChart = null;

        const colorsBase = {
            'Processado': '#10b981', 
            'Pendente': '#f59e0b',    
            'Erro': '#ef4444',       
            'Outros': '#64748b',     
            'Entrada': '#f97316',    
            'Saída': '#3b82f6',      
            'EntradaErro': '#b91c1c', 
            'SaídaErro': '#b91c1c'    
        };

        const DB_NAME = 'DashboardAnalyticsDB';
        const STORE_NAME = 'AppPersistence';

        async function getDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 8); 
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function saveToDB(key, val) {
            try {
                const db = await getDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).put(val, key);
                return new Promise((resolve) => tx.oncomplete = resolve);
            } catch (e) { console.warn("Erro ao gravar no DB", e); }
        }

        async function getFromDB(key) {
            try {
                const db = await getDB();
                const tx = db.transaction(STORE_NAME, 'readonly');
                const request = tx.objectStore(STORE_NAME).get(key);
                return new Promise((resolve) => request.onsuccess = () => resolve(request.result));
            } catch (e) { return null; }
        }

        async function removeFromDB(key) {
            try {
                const db = await getDB();
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).delete(key);
                return new Promise((resolve) => tx.oncomplete = resolve);
            } catch (e) {}
        }

        function normalizeActionStatus(status) {
            const s = String(status || "").trim().toLowerCase();
            if (s === "novo" || s === "pendente") return "Não iniciado";
            if (s === "em analise" || s === "em análise") return "Em analise";
            if (s === "concluido" || s === "concluído") return "Concluído";
            return status || "Não iniciado";
        }

        async function initFirebaseAuth() {
            const maxRetries = 3;
            let attempt = 0;
            const tryAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                        return true;
                    }
                    throw new Error("Token não disponível");
                } catch (error) {
                    try {
                        await auth.signInAnonymously();
                        return true;
                    } catch (anonError) {
                        return false;
                    }
                }
            };
            while (attempt < maxRetries) {
                const success = await tryAuth();
                if (success) break;
                attempt++;
                await new Promise(r => setTimeout(r, Math.pow(2, attempt) * 1000));
            }
        }

        async function syncActionsWithFirebase() {
            if (!firebaseUser) return;
            const syncIcon = document.getElementById('syncIndicator');
            if(syncIcon) syncIcon.classList.remove('opacity-0');
            try {
                const actionsCol = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('actions');
                const snapshot = await actionsCol.get();
                const remoteActions = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return { 
                        ...data, 
                        status: normalizeActionStatus(data.status), 
                        firebaseId: doc.id 
                    };
                });
                if (remoteActions.length > 0) {
                    registeredActions = remoteActions.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                    await saveToDB('registered_actions', registeredActions);
                    checkAndMapNewValuesFromList(registeredActions);
                    renderActionsTable();
                }
            } catch (error) {
                console.error("Erro na sincronização Firebase:", error);
            } finally {
                setTimeout(() => { if(syncIcon) syncIcon.classList.add('opacity-0'); }, 2000);
            }
        }

        async function uploadActionToFirebase(action) {
            if (!firebaseUser) return;
            try {
                const actionsCol = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('actions');
                await actionsCol.doc(action.id.toString()).set(action);
            } catch (error) {
                console.error("Firebase Upload Error:", error);
            }
        }

        async function removeActionFromFirebase(actionId) {
            if (!firebaseUser) return;
            try {
                const actionsCol = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('actions');
                await actionsCol.doc(actionId.toString()).delete();
            } catch (error) {
                console.error("Firebase Delete Error:", error);
            }
        }

        async function handleActionsImport(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const dataRaw = new Uint8Array(e.target.result);
                    const wb = XLSX.read(dataRaw, { type: 'array', cellDates: true });
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet);
                    if (rows.length === 0) {
                        showToast("Planilha vazia ou layout inválido.", "error");
                        return;
                    }
                    let importedCount = 0;
                    const now = Date.now();
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const dateObj = getSafeDate(row["Data"]);
                        const deadlineObj = getSafeDate(row["Prazo"]);
                        const rawStatus = String(row["Estado"] || "Não iniciado");
                        const statusMigrated = normalizeActionStatus(rawStatus);
                        const actionData = {
                            id: now + i,
                            date: dateObj ? formatDateToISO(dateObj) : formatDateToISO(new Date()),
                            priorityId: String(row["ID Prioridade"] || row["Prioridade"] || ""),
                            system: String(row["Sistema"] || "N/A"),
                            ref: String(row["Ref"] || ""),
                            user: String(row["Responsavel"] || "Sistema"),
                            title: String(row["Titulo"] || "Importado"),
                            desc: String(row["Descricao"] || ""),
                            resolution: String(row["Solucao"] || ""),
                            deadline: deadlineObj ? formatDateToISO(deadlineObj) : formatDateToISO(new Date()),
                            status: statusMigrated
                        };
                        registeredActions.unshift(actionData);
                        if (firebaseUser) await uploadActionToFirebase(actionData);
                        importedCount++;
                    }
                    await saveToDB('registered_actions', registeredActions);
                    checkAndMapNewValuesFromList(registeredActions);
                    renderActionsTable();
                    showToast(`${importedCount} ações importadas com sucesso!`, "success");
                    input.value = ""; 
                } catch (err) {
                    console.error("Erro na importação:", err);
                    showToast("Erro ao processar planilha.", "error");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function checkAndMapNewValuesFromList(list) {
            const statusDropdown = document.getElementById('actStatus');
            const systemDropdown = document.getElementById('actSystem');
            const filterStatusDropdown = document.getElementById('rep-filter-status');
            const filterSystemDropdown = document.getElementById('rep-filter-system');
            if (!statusDropdown || !systemDropdown) return;
            const existingStatuses = Array.from(statusDropdown.options).map(opt => opt.value);
            const existingSystems = Array.from(systemDropdown.options).map(opt => opt.value);
            list.forEach(act => {
                if (act.status && !existingStatuses.includes(act.status)) {
                    const newOpt = new Option(act.status, act.status);
                    statusDropdown.add(newOpt);
                    if (filterStatusDropdown) filterStatusDropdown.add(new Option(act.status, act.status));
                    existingStatuses.push(act.status);
                }
                if (act.system && !existingSystems.includes(act.system)) {
                    const newOpt = new Option(act.system, act.system);
                    systemDropdown.add(newOpt);
                    if (filterSystemDropdown) filterSystemDropdown.add(new Option(act.system, act.system));
                    existingSystems.push(act.system);
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const dashView = document.getElementById('dashboardView');
            const reportView = document.getElementById('reportView');
            const icon = document.getElementById('toggleSidebarIcon');
            if (!sidebar || !dashView || !reportView) return;
            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                sidebar.classList.remove('hidden');
                dashView.classList.replace('xl:col-span-12', 'xl:col-span-9');
                reportView.classList.replace('xl:col-span-12', 'xl:col-span-9');
                icon.setAttribute('data-lucide', 'panel-left-close');
            } else {
                sidebar.classList.add('hidden');
                dashView.classList.replace('xl:col-span-9', 'xl:col-span-12');
                reportView.classList.replace('xl:col-span-9', 'xl:col-span-12');
                icon.setAttribute('data-lucide', 'panel-left-open');
            }
            if(window.lucide) lucide.createIcons();
        }

        function switchView(view) {
            const dashboardView = document.getElementById('dashboardView');
            const reportView = document.getElementById('reportView');
            const bottomView = document.getElementById('dashboardBottomView');
            const navDash = document.getElementById('nav-dashboard');
            const navRep = document.getElementById('nav-report');
            if (view === 'dashboard') {
                dashboardView.classList.remove('hidden');
                reportView.classList.add('hidden');
                navDash.classList.add('active');
                navRep.classList.remove('active');
                if (rawData.length > 0) bottomView.classList.remove('hidden');
            } else {
                dashboardView.classList.add('hidden');
                reportView.classList.remove('hidden');
                bottomView.classList.add('hidden');
                navDash.classList.remove('active');
                navRep.classList.add('active');
                renderActionsTable();
            }
            if(window.lucide) lucide.createIcons();
        }

        function clearReportFilters() {
            document.getElementById('rep-filter-date').value = '';
            document.getElementById('rep-filter-priority').value = '';
            document.getElementById('rep-filter-system').value = '';
            document.getElementById('rep-filter-status').value = '';
            document.getElementById('rep-filter-deadline').value = '';
            document.getElementById('repTableLimit').value = '10';
            renderActionsTable();
            showToast("Filtros limpos.", "info");
        }

        function openDetailsModal(id) {
            const act = registeredActions.find(a => a.id === id);
            if (!act) return;
            document.getElementById('detTitle').textContent = act.title || 'Sem Título';
            document.getElementById('detSystem').textContent = act.system || 'N/A';
            document.getElementById('detRef').textContent = act.ref || 'N/A';
            document.getElementById('detPriority').textContent = act.priorityId || 'N/A';
            document.getElementById('detDesc').textContent = act.desc || 'Sem descrição.';
            document.getElementById('detResolution').textContent = act.resolution || 'Nenhuma resolução registada ainda.';
            document.getElementById('detailsModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        function openActionModal(id = null) {
            const form = document.getElementById('actionForm');
            const modalTitle = document.getElementById('actionModalTitle');
            form.reset();
            if (id) {
                const act = registeredActions.find(a => a.id === id);
                if (act) {
                    modalTitle.innerHTML = '<i data-lucide="edit-3" class="text-blue-600"></i> Editar Registo de Ação';
                    document.getElementById('actId').value = act.id;
                    document.getElementById('actTitle').value = act.title || '';
                    document.getElementById('actPriority').value = act.priorityId || '';
                    document.getElementById('actDate').value = act.date || '';
                    document.getElementById('actRef').value = act.ref || '';
                    document.getElementById('actSystem').value = act.system || '';
                    document.getElementById('actDeadline').value = act.deadline || '';
                    document.getElementById('actUser').value = act.user || '';
                    document.getElementById('actStatus').value = act.status || 'Não iniciado';
                    document.getElementById('actDesc').value = act.desc || '';
                    document.getElementById('actResolution').value = act.resolution || '';
                }
            } else {
                modalTitle.innerHTML = '<i data-lucide="plus-square" class="text-blue-600"></i> Novo Registo de Ação';
                document.getElementById('actId').value = '';
                document.getElementById('actDate').value = formatDateToISO(new Date());
                document.getElementById('actDeadline').value = formatDateToISO(new Date());
            }
            document.getElementById('actionModal').classList.remove('hidden');
            lucide.createIcons();
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.add('hidden');
        }

        async function saveAction(e) {
            e.preventDefault();
            const editId = document.getElementById('actId').value;
            const actionData = {
                id: editId ? parseInt(editId) : Date.now(),
                title: document.getElementById('actTitle').value,
                priorityId: document.getElementById('actPriority').value,
                date: document.getElementById('actDate').value,
                ref: document.getElementById('actRef').value,
                system: document.getElementById('actSystem').value,
                deadline: document.getElementById('actDeadline').value,
                user: document.getElementById('actUser').value,
                status: document.getElementById('actStatus').value,
                desc: document.getElementById('actDesc').value,
                resolution: document.getElementById('actResolution').value
            };
            if (editId) {
                const index = registeredActions.findIndex(a => a.id === parseInt(editId));
                if (index !== -1) registeredActions[index] = actionData;
                showToast("Registo atualizado!", "success");
            } else {
                registeredActions.unshift(actionData);
                showToast("Ação registada!", "success");
            }
            await saveToDB('registered_actions', registeredActions);
            if (firebaseUser) uploadActionToFirebase(actionData);
            closeActionModal();
            renderActionsTable();
        }

        async function deleteAction(id) {
            registeredActions = registeredActions.filter(a => a.id !== id);
            await saveToDB('registered_actions', registeredActions);
            if (firebaseUser) removeActionFromFirebase(id);
            renderActionsTable();
            showToast("Registo removido.", "info");
        }

        function renderActionsTable() {
            const tbody = document.getElementById('actionsTableBody');
            const emptyState = document.getElementById('actionsEmptyState');
            if(!tbody) return;
            tbody.innerHTML = '';
            const filterDate = document.getElementById('rep-filter-date').value;
            const filterPriority = normalizeString(document.getElementById('rep-filter-priority').value);
            const filterSystem = document.getElementById('rep-filter-system').value;
            const filterStatus = document.getElementById('rep-filter-status').value;
            const filterDeadline = document.getElementById('rep-filter-deadline').value;
            const limitVal = document.getElementById('repTableLimit').value;
            const limit = limitVal === 'all' ? Infinity : parseInt(limitVal);
            const filtered = registeredActions.filter(act => {
                const matchesDate = !filterDate || act.date === filterDate;
                const matchesPriority = !filterPriority || normalizeString(act.priorityId).includes(filterPriority);
                const matchesSystem = !filterSystem || act.system === filterSystem;
                const matchesStatus = !filterStatus || act.status === filterStatus;
                const matchesDeadline = !filterDeadline || act.deadline === filterDeadline;
                return matchesDate && matchesPriority && matchesSystem && matchesStatus && matchesDeadline;
            });
            filtered.sort((a, b) => {
                const getPriorityScore = (p) => {
                    const match = String(p || "").match(/^[Pp](\d+)/);
                    return match ? parseInt(match[1]) : 1000000;
                };
                const scoreA = getPriorityScore(a.priorityId);
                const scoreB = getPriorityScore(b.priorityId);
                if (scoreA !== scoreB) return scoreA - scoreB;
                return String(a.priorityId || "").localeCompare(String(b.priorityId || ""));
            });
            if (filtered.length === 0) {
                if(emptyState) emptyState.classList.remove('hidden');
                return;
            }
            if(emptyState) emptyState.classList.add('hidden');
            const displayList = filtered.slice(0, limit);
            displayList.forEach(act => {
                let statusColor = 'bg-slate-100 text-slate-700';
                switch (act.status) {
                    case 'Concluído': statusColor = 'bg-emerald-100 text-emerald-700'; break;
                    case 'Não iniciado': statusColor = 'bg-red-100 text-red-700'; break;
                    case 'Em analise': statusColor = 'bg-blue-100 text-blue-700'; break;
                    case 'Em andamento': statusColor = 'bg-indigo-100 text-indigo-700'; break;
                    case 'Em acompanhamento': statusColor = 'bg-slate-100 text-slate-700'; break;
                    case 'Em teste': statusColor = 'bg-orange-100 text-orange-700'; break;
                }
                const sysTag = act.system === 'Protheus' ? 'text-indigo-600' : 'text-orange-600';
                const fmtDate = (typeof act.date === 'string' && act.date.includes('-')) ? act.date.split('-').reverse().join('/') : (act.date || '-');
                const fmtDeadline = (typeof act.deadline === 'string' && act.deadline.includes('-')) ? act.deadline.split('-').reverse().join('/') : (act.deadline || '-');
                tbody.innerHTML += `
                    <tr class="hover:bg-slate-50/50 transition-colors">
                        <td class="px-6 py-4 font-mono text-xs text-slate-500 whitespace-nowrap">${fmtDate}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">
                            <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded text-[10px] font-bold border border-indigo-100">
                                ${act.priorityId || '-'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${act.ref ? `<div class="font-bold text-slate-700">${act.ref}</div>` : ''}
                            <div class="text-[10px] uppercase font-black ${sysTag}">${act.system || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 text-slate-600 whitespace-nowrap">${act.user}</td>
                        <td onclick="openDetailsModal(${act.id})" class="px-6 py-4 text-slate-600 clickable-row-cell">
                            <div class="text-xs font-black text-slate-800 uppercase tracking-tight mb-0.5">${act.title || 'Sem Título'}</div>
                            <div class="max-w-xs truncate text-[11px] text-slate-500" title="Clique para ver detalhes">${act.desc}</div>
                            ${act.resolution ? `<div class="text-[10px] text-emerald-600 mt-1 italic truncate max-w-xs"><strong>Solução:</strong> ${act.resolution}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 text-center font-mono text-xs text-slate-500 whitespace-nowrap">${fmtDeadline}</td>
                        <td class="px-6 py-4 text-center whitespace-nowrap">
                            <span class="inline-block px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider ${statusColor} min-w-[120px] text-center">
                                ${act.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-right whitespace-nowrap">
                            <div class="flex items-center justify-end gap-2">
                                <button onclick="openActionModal(${act.id})" class="text-slate-300 hover:text-blue-500 transition p-1" title="Editar">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteAction(${act.id})" class="text-slate-300 hover:text-red-500 transition p-1" title="Eliminar">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        function exportActionsToCSV() {
            if (registeredActions.length === 0) {
                showToast("Não existem ações para exportar.", "info");
                return;
            }
            const csvHeaders = ["Data", "ID Prioridade", "Sistema", "Ref", "Responsavel", "Titulo", "Descricao", "Solucao", "Prazo", "Estado"];
            const formatCell = (val) => {
                let text = String(val || "").replace(/"/g, '""');
                return `"${text}"`;
            };
            const rows = registeredActions.map(act => [
                formatCell(act.date), formatCell(act.priorityId), formatCell(act.system), formatCell(act.ref), formatCell(act.user), formatCell(act.title), formatCell(act.desc), formatCell(act.resolution), formatCell(act.deadline), formatCell(act.status)
            ]);
            const csvContent = csvHeaders.join(";") + "\n" + rows.map(r => r.join(";")).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            const timestamp = new Date().toISOString().slice(0,10).replace(/-/g, '');
            link.setAttribute("href", url);
            link.setAttribute("download", `Relatorio_Acoes_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast("Exportação de ações concluída!", "success");
        }

        function getSafeDate(val) {
            if (!val) return null;
            if (val instanceof Date) return val;
            if (typeof val === 'number' && val > 0) return new Date(Math.round((val - 25569) * 86400 * 1000));
            const str = String(val).trim();
            if (!str || str === '0' || str.toLowerCase() === 'null') return null;
            let dateObj = null;
            const datePart = str.split(' ')[0];
            if (/^\d{1,2}\/\d{1,2}\/\d{4}/.test(datePart)) {
                const parts = datePart.split('/');
                dateObj = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
            } else if (/^\d{4}-\d{2}-\d{2}/.test(datePart)) {
                const parts = datePart.split('-');
                dateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            } else {
                dateObj = new Date(str);
            }
            return (isNaN(dateObj.getTime()) || dateObj.getFullYear() < 1900) ? null : dateObj;
        }

        function formatDateToISO(date) {
            if (!(date instanceof Date) || isNaN(date.getTime())) return "";
            const year = date.getFullYear(), month = String(date.getMonth() + 1).padStart(2, '0'), day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getContrastColor(hexColor) {
            if (!hexColor || hexColor[0] !== '#') return '#1e293b';
            const r = parseInt(hexColor.slice(1, 3), 16), g = parseInt(hexColor.slice(3, 5), 16), b = parseInt(hexColor.slice(5, 7), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#1e293b' : '#ffffff';
        }

        let columnMapping = { 'data': '', 'hora': '', 'sistema': '', 'direcao': '', 'status': '', 'id': '' };
        const possibleNames = {
            'data': ['data', 'date', 'dia', 'dt_ocorrencia', 'período', 'dt'],
            'hora': ['hora', 'time', 'horario', 'hr_ocorrencia', 'hr'],
            'sistema': ['sistema', 'system', 'origem', 'aplicacao', 'app', 'modulo', 'orig'],
            'direcao': ['direcao', 'direction', 'tipo_movimento', 'fluxo', 'tipo', 'sentido', 'mov', 'movimento', 'op', 'operacao', 'e/s', 'es'],
            'status': ['status', 'situacao', 'estado', 'resultado', 'sit'],
            'id': ['id', 'identificador', 'codigo', 'protocolo', 'chave', 'num', 'numero', 'referencia', 'lote', 'asn', 'oexp', 'ordem']
        };

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                if(window.lucide) lucide.createIcons();
                setupNotesAutoSave();
                directoryHandle = await getFromDB('last_dir_handle');
                if (directoryHandle) {
                    document.getElementById('mainFolderBtn').innerHTML = '<i data-lucide="unlock" class="w-4 h-4"></i> Reativar Pasta Local';
                    if(window.lucide) lucide.createIcons();
                }
                analysisEvidences = await getFromDB('analysis_evidences') || {};
                const savedActions = await getFromDB('registered_actions') || [];
                registeredActions = savedActions.map(act => ({ ...act, status: normalizeActionStatus(act.status) }));
                checkAndMapNewValuesFromList(registeredActions);
                const savedData = await getFromDB('last_raw_data');
                if (savedData) {
                    rawData = savedData;
                    headers = await getFromDB('last_headers') || [];
                    currentFileName = await getFromDB('last_filename') || '';
                    columnMapping = await getFromDB('last_mapping') || columnMapping;
                    updateAppState(true);
                    runDashboardAnalysis();
                    loadSavedNotes();
                }
                await initFirebaseAuth();
                auth.onAuthStateChanged(user => {
                    firebaseUser = user;
                    if (user) syncActionsWithFirebase();
                });
            } catch (err) { console.warn("Inicialização segura concluída."); }
        });

        function openEvidenceModal(id) {
            currentEvidenceId = id;
            const evidence = analysisEvidences[id] || { note: '', completed: false, status: 'Processado com sucesso' };
            document.getElementById('evidenceTargetId').textContent = id;
            document.getElementById('evidenceNote').value = evidence.note || '';
            document.getElementById('evidenceStatus').value = evidence.status || 'Processado com sucesso';
            document.getElementById('evidenceCompleted').checked = evidence.completed || false;
            document.getElementById('evidenceModal').classList.remove('hidden');
            lucide.createIcons();
        }
        function closeEvidenceModal() { document.getElementById('evidenceModal').classList.add('hidden'); }

        async function saveEvidence() {
            const note = document.getElementById('evidenceNote').value.trim();
            const status = document.getElementById('evidenceStatus').value;
            const completed = document.getElementById('evidenceCompleted').checked;
            const timestamp = new Date().toISOString();
            analysisEvidences[currentEvidenceId] = { note, status, timestamp, completed };
            await saveToDB('analysis_evidences', analysisEvidences);
            showToast(completed ? "ID marcado como concluído!" : "Análise atualizada!", "success");
            closeEvidenceModal();
            renderBalanceTable(); 
        }

        function handleFallbackFolder(input) {
            const files = Array.from(input.files);
            const container = document.getElementById('dirFileList');
            if(!container) return;
            container.innerHTML = '';
            container.classList.remove('hidden');
            const refreshBtn = document.getElementById('refreshDirBtn');
            if(refreshBtn) refreshBtn.classList.remove('hidden');
            const excelFiles = files.filter(f => ['.xlsx', '.xls', '.csv'].some(ex => f.name.toLowerCase().endsWith(ex)));
            excelFiles.forEach(file => {
                const b = document.createElement('button');
                b.setAttribute('data-filename', file.name);
                b.className = "w-full text-left p-2 hover:bg-slate-50 border border-slate-100 rounded text-[10px] truncate flex items-center gap-2 transition-colors";
                b.innerHTML = `<i data-lucide="file-text" class="w-3 h-3 text-slate-400"></i>${file.name}`;
                b.onclick = () => processFile(file);
                container.appendChild(b);
            });
            if (window.lucide) lucide.createIcons();
            if (excelFiles.length > 0) showToast(`${excelFiles.length} ficheiros carregados da pasta.`, "success");
        }

        async function selectLocalDirectory() {
            if (!window.showDirectoryPicker) {
                document.getElementById('folderInputFallback').click();
                return;
            }
            try {
                const isReactivating = document.getElementById('mainFolderBtn').innerText.includes('Reativar');
                if (isReactivating && directoryHandle) {
                    const status = await directoryHandle.requestPermission({ mode: 'read' });
                    if (status === 'granted') {
                        await scanDirectory(true);
                        showToast("Pasta reativada!", "success");
                        return;
                    }
                }
                const handle = await window.showDirectoryPicker({ mode: 'read' });
                directoryHandle = handle;
                await saveToDB('last_dir_handle', handle); 
                document.getElementById('mainFolderBtn').innerHTML = '<i data-lucide="unlock" class="w-4 h-4"></i> Reativar Pasta Local'; 
                await scanDirectory(true); 
                showToast("Pasta mapeada!", "success");
            } catch(e) { if (e.name !== 'AbortError') showToast("Erro ao aceder à pasta.", "error"); }
        }

        async function verifyPermission(handle) {
            if (!handle) return false;
            try {
                const options = { mode: 'read' }; 
                if ((await handle.queryPermission(options)) === 'granted') return true; 
                if ((await handle.requestPermission(options)) === 'granted') return true; 
            } catch (err) { console.error("Erro permissão:", err); }
            return false;
        }

        async function scanDirectory(skipPermissionCheck = false) {
            if (!directoryHandle) return; 
            try {
                if (!skipPermissionCheck) {
                    const isGranted = await verifyPermission(directoryHandle); 
                    if (!isGranted) { showToast("Permissão negada.", "error"); return; }
                }
                const container = document.getElementById('dirFileList'); if(!container) return;
                container.innerHTML = ''; container.classList.remove('hidden'); 
                const refreshBtn = document.getElementById('refreshDirBtn'); if(refreshBtn) refreshBtn.classList.remove('hidden');
                for await (const entry of directoryHandle.values()) {
                    if (entry.kind === 'file' && ['.xlsx', '.xls', '.csv'].some(ex => entry.name.toLowerCase().endsWith(ex))) {
                        const b = document.createElement('button'); 
                        b.setAttribute('data-filename', entry.name); 
                        b.className = "w-full text-left p-2 hover:bg-slate-50 border border-slate-100 rounded text-[10px] truncate flex items-center gap-2 transition-colors";
                        b.innerHTML = `<i data-lucide="file-text" class="w-3 h-3 text-slate-400"></i>${entry.name}`; 
                        b.onclick = async () => {
                            try { const file = await entry.getFile(); processFile(file); } catch (err) { showToast("Erro ao abrir ficheiro.", "error"); }
                        };
                        container.appendChild(b);
                    }
                }
                highlightActiveFile(); lucide.createIcons();
            } catch (err) { showToast("Erro ao ler pasta.", "error"); }
        }

        async function processFile(file) {
            if (!file) return; 
            const reader = new FileReader();
            reader.onload = async e => {
                try {
                    const dataRaw = new Uint8Array(e.target.result), wb = XLSX.read(dataRaw, { type: 'array', cellDates: true });
                    let initialData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                    if (initialData.length > 0) {
                        const seen = new Set(); rawData = initialData.filter(row => { const key = JSON.stringify(row); return seen.has(key) ? false : seen.add(key); });
                        headers = Object.keys(rawData[0]); currentFileName = file.name; guessMappings();
                        await saveToDB('last_raw_data', rawData); await saveToDB('last_headers', headers); await saveToDB('last_filename', currentFileName); await saveToDB('last_mapping', columnMapping);
                        updateAppState(true); runDashboardAnalysis(); loadSavedNotes();
                    }
                } catch (err) { showToast("Erro ao processar ficheiro.", "error"); }
            };
            reader.readAsArrayBuffer(file);
        }

        function guessMappings() {
            for (const k in columnMapping) {
                columnMapping[k] = ''; const poss = possibleNames[k];
                for (const h of headers) { const c = h.toLowerCase().trim().replace(/[_\s\.]/g, ''); if (poss.includes(c)) { columnMapping[k] = h; break; } }
            }
        }

        function highlightActiveFile() {
            const list = document.getElementById('dirFileList'); if(!list) return;
            const buttons = list.querySelectorAll('button');
            buttons.forEach(btn => { if (btn.getAttribute('data-filename') === currentFileName) btn.classList.add('file-item-active'); else btn.classList.remove('file-item-active'); });
        }

        function updateAppState(has) {
            const ids = ['fileInfo', 'statusSection', 'section-notes', 'dashboardChartsContainer', 'dashboardBottomView'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.classList.toggle('hidden', !has); });
            const emptyState = document.getElementById('emptyState'); if (emptyState) emptyState.classList.toggle('hidden', has);
            const fileNameEl = document.getElementById('fileName'); if (fileNameEl) fileNameEl.textContent = currentFileName;
            const lastUpdateTag = document.getElementById('lastUpdateTag'), lastUpdateText = document.getElementById('lastUpdateText');
            if (has) {
                let latestDate = null;
                if (rawData && rawData.length > 0) {
                    const dCol = columnMapping['data'], tCol = columnMapping['hora'];
                    let maxTime = 0;
                    rawData.forEach(row => {
                        const dt = getSafeDate(row[dCol]);
                        if (dt) {
                            let currentTimeInMs = dt.getTime();
                            if (tCol && row[tCol] !== undefined) {
                                const valHora = row[tCol]; let h = 0, m = 0;
                                if (valHora instanceof Date) { h = valHora.getHours(); m = valHora.getMinutes(); } 
                                else if (typeof valHora === 'number') { const totalSecs = Math.floor(valHora * 86400); h = Math.floor(totalSecs / 3600); m = Math.floor((totalSecs % 3600) / 60); }
                                else { const parts = String(valHora).split(':'); h = parseInt(parts[0]) || 0; m = parseInt(parts[1]) || 0; }
                                const tempDate = new Date(dt); tempDate.setHours(h, m, 0, 0); currentTimeInMs = tempDate.getTime();
                            }
                            if (currentTimeInMs > maxTime) maxTime = currentTimeInMs;
                        }
                    });
                    if (maxTime > 0) latestDate = new Date(maxTime);
                }
                const displayDate = latestDate || new Date();
                const timeStr = displayDate.toLocaleTimeString('pt-PT', { hour: '2-digit', minute: '2-digit' });
                const dateStr = displayDate.toLocaleDateString('pt-PT', { day: '2-digit', month: '2-digit', year: 'numeric' });
                if (lastUpdateText) lastUpdateText.textContent = `${dateStr} às ${timeStr}`; 
                if (lastUpdateTag) { lastUpdateTag.classList.remove('hidden'); lastUpdateTag.classList.add('flex'); }
                highlightActiveFile(); renderDetectedCols();
                const titleEl = document.getElementById('balanceTableTitle'), headerEl = document.getElementById('idColumnHeader'), fName = currentFileName.toUpperCase();
                if (fName.includes('ASN')) { if(titleEl) titleEl.innerHTML = '<i data-lucide="arrow-right-left" class="w-4 h-4 text-orange-500"></i> Entradas e Saídas - ASN'; if(headerEl) headerEl.textContent = 'ASN (ID)'; }
                else if (fName.includes('OEXP')) { if(titleEl) titleEl.innerHTML = '<i data-lucide="arrow-right-left" class="w-4 h-4 text-orange-500"></i> Entradas e Saídas - Ordem de expedição'; if(headerEl) headerEl.textContent = 'OEXP (ID)'; }
            } else { if (lastUpdateTag) lastUpdateTag.classList.add('hidden'); }
            if(window.lucide) lucide.createIcons();
        }

        function renderDetectedCols() {
            const c = document.getElementById('detectedCols'); if(!c) return;
            c.innerHTML = '';
            Object.entries(columnMapping).forEach(([k, v]) => { if(v) c.innerHTML += `<span class="px-2 py-0.5 bg-blue-50 text-blue-600 rounded text-[10px] border border-blue-200">${k}: ${v}</span>`; });
        }

        function refreshDashboard() {
            const dateStartInput = document.getElementById('dateStart'), dateEndInput = document.getElementById('dateEnd');
            const dateStart = dateStartInput ? dateStartInput.value : '', dateEnd = dateEndInput ? dateEndInput.value : '';
            const lineView = document.getElementById('lineViewSelector').value;
            if (dateStart) localStorage.setItem('persist_dateStart', dateStart); 
            if (dateEnd) localStorage.setItem('persist_dateEnd', dateEnd);
            localStorage.setItem('persist_lineView', lineView);
            updateLineChart(); renderBarChart(); renderDoughnutChart(); renderBalanceTable();
        }

        function runDashboardAnalysis() { setupDateFilters(); refreshDashboard(); }
        function normalizeString(v) { if (v === undefined || v === null) return ''; return String(v).toLowerCase().trim().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); }
        function normalizeDirection(v) {
            const s = normalizeString(v); if (['e', '1'].includes(s) || s.startsWith('ent') || s.includes('in')) return 'Entrada'; if (['s', '2'].includes(s) || s.startsWith('sai') || s.includes('out')) return 'Saída'; return 'Outro';
        }
        function getStatusCategory(v) {
            const s = normalizeString(v); if (s.includes('proc') || s.includes('concl') || s.includes('ok') || s === 'sucesso' || s === 'p') return 'Processado'; if (s.includes('pend') || s.includes('aguard') || s === 'a') return 'Pendente'; if (s.includes('erro') || s.includes('falh') || s.includes('diverg') || s === 'e') return 'Erro'; return 'Outros';
        }

        function setupDateFilters() {
            const dateStartInput = document.getElementById('dateStart'), dateEndInput = document.getElementById('dateEnd'), lineViewSelector = document.getElementById('lineViewSelector');
            const savedStart = localStorage.getItem('persist_dateStart'), savedEnd = localStorage.getItem('persist_dateEnd'), savedView = localStorage.getItem('persist_lineView');
            if (savedView && lineViewSelector) lineViewSelector.value = savedView;
            if (savedStart && savedEnd && dateStartInput && dateEndInput) { dateStartInput.value = savedStart; dateEndInput.value = savedEnd; return; }
            const col = columnMapping['data']; if(!col) return;
            const dates = rawData.map(r => getSafeDate(r[col])).filter(d => d);
            if(dates.length) { const min = dates.reduce((a, b) => a < b ? a : b), max = dates.reduce((a, b) => a > b ? a : b); if(dateStartInput) dateStartInput.value = formatDateToISO(min); if(dateEndInput) dateEndInput.value = formatDateToISO(max); }
        }

        function getFilteredData() {
            const dCol = columnMapping['data'], startInput = document.getElementById('dateStart'), endInput = document.getElementById('dateEnd');
            const startStr = startInput ? startInput.value : '', endStr = endInput ? endInput.value : '';
            return rawData.filter(r => { const dateVal = getSafeDate(r[dCol]); if (!dateVal) return true; const dISO = formatDateToISO(dateVal); if (!startStr || !endStr) return true; return dISO >= startStr && dISO <= endStr; });
        }

        function updateLineChart() {
            const dCol = columnMapping['data'], tCol = columnMapping['hora'], sCol = columnMapping['status'], dirCol = columnMapping['direcao'], sysCol = columnMapping['sistema'];
            const dataRawFiltered = getFilteredData(), viewType = document.getElementById('lineViewSelector').value;
            const isOEXP = currentFileName.toUpperCase().includes('OEXP');
            const sKey = sysCol || (headers.find(h => { const n = normalizeString(h); return n.includes('sistema') || n.includes('origem'); }) || '');
            const data = dataRawFiltered.filter(r => {
                if (viewType === 'all') return true; 
                const dir = normalizeDirection(r[dirCol]), sysRaw = sKey ? String(r[sKey] || '').toUpperCase() : '';
                const isWMSExplicit = sysRaw.includes('WMS'), isProtheusExplicit = sysRaw.includes('PROTHEUS') || sysRaw.includes('ERP') || sysRaw.includes('TOTVS') || sysRaw.includes('SXS');
                const isRowWMS = isWMSExplicit || (!isProtheusExplicit && (isOEXP ? dir === 'Saída' : dir === 'Entrada'));
                const isRowProtheus = isProtheusExplicit || (!isWMSExplicit && (isOEXP ? dir === 'Entrada' : dir === 'Saída'));
                if (viewType === 'wms') return isRowWMS; if (viewType === 'protheus') return isRowProtheus;
                return true;
            });
            const cats = { 'Processado': { color: colorsBase.Processado, data: Array(24).fill(0) }, 'Pendente': { color: colorsBase.Pendente, data: Array(24).fill(0) }, 'Erro': { color: colorsBase.Erro, data: Array(24).fill(0) }, 'Outros': { color: colorsBase.Outros, data: Array(24).fill(0) } };
            data.forEach(r => {
                const valHora = r[tCol]; let h = 0; if (valHora instanceof Date) h = valHora.getHours(); else if (typeof valHora === 'number') h = Math.floor(valHora < 1 ? valHora * 24 : valHora); else h = parseInt(String(valHora || '0').split(':')[0]);
                const c = getStatusCategory(r[sCol]); if(h >= 0 && h < 24 && cats[c]) cats[c].data[h]++;
            });
            const filteredDatasets = Object.entries(cats).filter(([_, obj]) => obj.data.some(val => val > 0)).map(([name, obj]) => ({ label: name, data: obj.data, borderColor: obj.color, backgroundColor: obj.color, tension: 0.3, pointRadius: 3, pointHoverRadius: 5 }));
            const ctx = document.getElementById('lineChartCanvas'); if(!ctx) return;
            if(lineChart) lineChart.destroy();
            lineChart = new Chart(ctx.getContext('2d'), {
                type: 'line', data: { labels: Array.from({length:24}, (_,i)=>`${String(i).padStart(2, '0')}:00`), datasets: filteredDatasets },
                options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true, ticks: { precision: 0 }, grace: '25%' } }, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }, datalabels: { display: (context) => context.dataset.data[context.dataIndex] > 0, align: 'top', offset: 4, color: (context) => context.dataset.borderColor, font: { size: 10, weight: 'bold' }, formatter: (v) => v || '' } } }
            });
        }

        function renderBarChart() {
            const canvas = document.getElementById('barChartCanvas'); if(!canvas) return;
            const ctx = canvas.getContext('2d'); if(barChart) { barChart.destroy(); barChart = null; }
            const dirCol = columnMapping['direcao'], statCol = columnMapping['status'], sysCol = columnMapping['sistema'], data = getFilteredData();
            const agg = { 'WMS': { e_ok:0, e_err:0, e_pend:0, s_ok:0, s_err:0, s_pend:0 }, 'PROTHEUS': { e_ok:0, e_err:0, e_pend:0, s_ok:0, s_err:0, s_pend:0 } };
            const dirKey = dirCol || (headers.find(h => normalizeString(h).includes('direcao')) || 'Direção'), stKey = statCol || (headers.find(h => normalizeString(h).includes('status')) || 'Status'), sysKey = sysCol || (headers.find(h => { const n = normalizeString(h); return n.includes('sistema') || n.includes('origem'); }) || 'Sistema');
            const isOEXP = currentFileName.toUpperCase().includes('OEXP');
            data.forEach(r => {
                const dir = normalizeDirection(r[dirKey]), stat = getStatusCategory(r[stKey]); if(dir === 'Outro') return;
                const sysRaw = sysKey ? String(r[sysKey] || '').toUpperCase() : '';
                const isWMS = sysRaw.includes('WMS'), isProtheus = sysRaw.includes('PROTHEUS') || sysRaw.includes('ERP') || sysRaw.includes('TOTVS') || sysRaw.includes('SXS');
                const isRowWMS = isWMS || (!isProtheus && (isOEXP ? dir === 'Saída' : dir === 'Entrada'));
                const isRowProtheus = isProtheus || (!isWMS && (isOEXP ? dir === 'Entrada' : dir === 'Saída'));
                let targetSys = isRowWMS ? 'WMS' : 'PROTHEUS';
                if(dir === 'Entrada') { if(stat === 'Processado') agg[targetSys].e_ok++; else if(stat === 'Erro') agg[targetSys].e_err++; else if(stat === 'Pendente') agg[targetSys].e_pend++; }
                else if(dir === 'Saída') { if(stat === 'Processado') agg[targetSys].s_ok++; else if(stat === 'Erro') agg[targetSys].s_err++; else if(stat === 'Pendente') agg[targetSys].s_pend++; }
            });
            const labels = ['WMS', 'PROTHEUS'];
            barChart = new Chart(ctx, {
                type: 'bar', data: { labels, datasets: [
                    { label: 'Saída OK', data: labels.map(l => agg[l].s_ok), backgroundColor: colorsBase.Saída },
                    { label: 'Saída Pendente', data: labels.map(l => agg[l].s_pend), backgroundColor: '#60a5fa' },
                    { label: 'Saída Erro', data: labels.map(l => agg[l].s_err), backgroundColor: colorsBase.SaídaErro },
                    { label: 'Entrada OK', data: labels.map(l => agg[l].e_ok), backgroundColor: colorsBase.Entrada },
                    { label: 'Entrada Pendente', data: labels.map(l => agg[l].e_pend), backgroundColor: '#fbbf24' },
                    { label: 'Entrada Erro', data: labels.map(l => agg[l].e_err), backgroundColor: colorsBase.EntradaErro }
                ]},
                options: { responsive:true, maintainAspectRatio:false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, grace: '10%' } }, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, datalabels: { display: (c) => c.dataset.data[c.dataIndex] > 0, color: (c) => getContrastColor(c.dataset.backgroundColor), font: { weight: 'bold', size: 10 }, formatter: v => v || '' } } }
            });
        }

        function renderDoughnutChart() {
            const canvas = document.getElementById('doughnutChartCanvas'); if(!canvas) return;
            const col = columnMapping['status'], data = getFilteredData(), counts = {}; data.forEach(r => { const s = r[col] || 'N/A'; counts[s] = (counts[s]||0)+1; });
            const labels = Object.keys(counts), bgColors = labels.map(l => colorsBase[getStatusCategory(l)] || colorsBase.Outros), ctx = canvas.getContext('2d');
            if(doughnutChart) doughnutChart.destroy();
            doughnutChart = new Chart(ctx, {
                type: 'doughnut', data: { labels, datasets: [{ data: Object.values(counts), backgroundColor: bgColors }]},
                options: { responsive:true, maintainAspectRatio:false, cutout: '70%', plugins: { 
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }, 
                    datalabels: { 
                        display: true, 
                        color: (context) => getContrastColor(context.dataset.backgroundColor[context.dataIndex]),
                        font: { weight: 'bold', size: 11 }, 
                        formatter: (v) => v || '' 
                    } 
                } }
            });
        }

        function renderBalanceTable() {
            const idCol = columnMapping['id'], dataCol = columnMapping['data'], dirCol = columnMapping['direcao'], statCol = columnMapping['status'], sysCol = columnMapping['sistema'], data = getFilteredData();
            const tbody = document.getElementById('balanceTableBody'); if(!tbody) return;
            tbody.innerHTML = '';
            const limitVal = document.getElementById('tableLimit').value, limit = limitVal === 'all' ? Infinity : parseInt(limitVal);
            const filterDateInput = document.getElementById('filter-balance-date'), filterIdInput = document.getElementById('filter-id'), filterStatInput = document.getElementById('filter-status'), filterMotivoInput = document.getElementById('filter-motivo');
            const fDate = normalizeString(filterDateInput?.value || ''), fId = normalizeString(filterIdInput?.value || ''), fStat = normalizeString(filterStatInput?.value || ''), fMotivo = normalizeString(filterMotivoInput?.value || '');
            const iKey = idCol || (headers.find(h => { const n = normalizeString(h); return n.includes('id') || n.includes('asn') || n.includes('oexp'); }) || headers[0]);
            const dKey = dirCol || (headers.find(h => normalizeString(h).includes('direcao')) || ''), sKey = statCol || (headers.find(h => normalizeString(h).includes('status')) || ''), sysKey = sysCol || (headers.find(h => { const n = normalizeString(h); return n.includes('sistema') || n.includes('origem'); }) || 'Sistema');
            const isOEXP = currentFileName.toUpperCase().includes('OEXP');
            const map = new Map();
            data.forEach(r => {
                let id = r[iKey]; if(id === undefined || id === null || id === '') return;
                id = String(id).trim(); const sysRaw = String(r[sysKey] || '').toUpperCase();
                const isWMS = sysRaw.includes('WMS'), isProtheus = sysRaw.includes('PROTHEUS') || sysRaw.includes('ERP') || sysRaw.includes('TOTVS') || sysRaw.includes('SXS');
                const dir = normalizeDirection(r[dKey]), stat = getStatusCategory(r[sKey]);
                if(!map.has(id)) {
                    const dtRaw = getSafeDate(r[dataCol]);
                    const fmtDate = dtRaw ? formatDateToISO(dtRaw).split('-').reverse().join('/') : '-';
                    map.set(id, { date: fmtDate, e_ok: 0, s_ok: 0, e_pend: 0, s_pend: 0, e_err: 0, s_err: 0 });
                }
                const o = map.get(id), isRowWMS = isWMS || (!isProtheus && (isOEXP ? dir === 'Saída' : dir === 'Entrada')), isRowProtheus = isProtheus || (!isWMS && (isOEXP ? dir === 'Entrada' : dir === 'Saída'));
                if(dir === 'Entrada') { if(stat === 'Processado') o.e_ok++; else if(stat === 'Pendente') o.e_pend++; else if(stat === 'Erro') o.e_err++; }
                else if(dir === 'Saída') { if(stat === 'Processado') o.s_ok++; else if(stat === 'Pendente') o.s_pend++; else if(stat === 'Erro') o.s_err++; }
            });
            const entries = Array.from(map.entries());
            const filteredEntries = entries.filter(([id, v]) => {
                if (analysisEvidences[id]?.completed) return false;
                const hasError = v.s_err > 0 || v.e_err > 0, hasPending = v.s_pend > 0 || v.e_pend > 0, isDivergent = (v.s_ok > 0 && v.e_ok === 0) || (v.e_ok > 0 && v.s_ok === 0);
                if (!hasError && !hasPending && !isDivergent) return false;
                let statusParts = [];
                if (v.s_err > 0) statusParts.push("Erro saída"); if (v.e_err > 0) statusParts.push("Erro entrada"); 
                if (v.s_pend > 0) statusParts.push("Pendente saída"); if (v.e_pend > 0 || (v.s_ok > 0 && v.e_ok === 0 && v.e_err === 0)) statusParts.push("Pendente entrada");
                const statusMsg = statusParts.join(" | ") || "Analisar";
                const ev = analysisEvidences[id]; const motivoStr = ev ? `${ev.status || ''} ${ev.note || ''}`.trim() : '';
                return (!fDate || normalizeString(v.date).includes(fDate)) && (!fId || normalizeString(id).includes(fId)) && (!fStat || normalizeString(statusMsg).includes(fStat)) && (!fMotivo || normalizeString(motivoStr).includes(fMotivo));
            }).map(([id, v]) => {
                let statusParts = [], statusClass = 'text-red-500 font-bold', diffVal = (v.s_ok > 0 && v.e_ok > 0) ? 0 : -1;
                if (v.s_err > 0) statusParts.push("Erro saída"); if (v.e_err > 0) statusParts.push("Erro entrada");
                if (v.s_pend > 0 || v.e_pend > 0 || (v.s_ok > 0 && v.e_ok === 0 && v.e_err === 0)) { statusParts.push(v.s_pend > 0 ? "Pendente saída" : "Pendente entrada"); statusClass = 'text-orange-600 font-bold'; }
                const ev = analysisEvidences[id]; let displayMotivo = ev ? (ev.status ? `<span class="bg-indigo-50 text-indigo-600 px-1 rounded font-bold">${ev.status}</span> ${ev.note || ''}` : ev.note) : '-';
                return { id, v, statusMsg: statusParts.join(" | ") || "Analisar", statusClass, diffVal, displayMotivo, rawMotivo: ev ? `${ev.status} ${ev.note}` : '' };
            });
            const displayEntries = filteredEntries.slice(0, limit);
            if(displayEntries.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="p-4 text-center text-slate-400 italic">Nada crítico.</td></tr>'; return; }
            displayEntries.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-2 border-b text-center text-slate-500 font-mono text-xs whitespace-nowrap">${item.v.date}</td>
                        <td class="px-4 py-2 border-b font-mono text-xs">${item.id}</td>
                        <td class="px-4 py-2 border-b text-center text-green-700 bg-green-50/10">${item.v.e_ok}</td>
                        <td class="px-4 py-2 border-b text-center text-blue-700 bg-blue-50/10">${item.v.s_ok}</td>
                        <td class="px-4 py-2 border-b text-center bg-slate-50 font-bold ${item.diffVal < 0 ? 'text-red-600':'text-slate-400'}">${item.diffVal}</td>
                        <td class="px-4 py-2 border-b text-center text-[10px] ${item.statusClass}">${item.statusMsg}</td>
                        <td class="px-4 py-2 border-b text-[10px] text-slate-500 italic max-w-[200px] truncate" title="${item.rawMotivo || ''}">${item.displayMotivo}</td>
                        <td class="px-4 py-2 border-b text-center">
                            <button onclick="openEvidenceModal('${item.id}')" class="p-1.5 text-indigo-500 hover:bg-indigo-50 rounded-lg transition"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        </td>
                    </tr>`;
            });
            lucide.createIcons();
        }

        function exportTableToCSV() {
            if (rawData.length === 0) return;
            const data = getFilteredData();
            const idCol = columnMapping['id'], dataCol = columnMapping['data'], dirCol = columnMapping['direcao'], statCol = columnMapping['status'], sysCol = columnMapping['sistema'];
            const iKey = idCol || (headers.find(h => { const n = normalizeString(h); return n.includes('id') || n.includes('asn'); }) || headers[0]);
            const dKey = dirCol || (headers.find(h => normalizeString(h).includes('direcao')) || ''), sKey = statCol || (headers.find(h => normalizeString(h).includes('status')) || '');
            const map = new Map();
            data.forEach(r => {
                let id = r[iKey]; if(!id) return;
                id = String(id).trim();
                const dir = normalizeDirection(r[dKey]), stat = getStatusCategory(r[sKey]);
                if(!map.has(id)) {
                    const dtRaw = getSafeDate(r[dataCol]);
                    const fmtDate = dtRaw ? formatDateToISO(dtRaw).split('-').reverse().join('/') : '-';
                    map.set(id, { date: fmtDate, e_ok: 0, s_ok: 0, e_pend: 0, s_pend: 0, e_err: 0, s_err: 0 });
                }
                const o = map.get(id);
                if(dir === 'Entrada') { if(stat === 'Processado') o.e_ok++; else if(stat === 'Pendente') o.e_pend++; else if(stat === 'Erro') o.e_err++; }
                else if(dir === 'Saída') { if(stat === 'Processado') o.s_ok++; else if(stat === 'Pendente') o.s_pend++; else if(stat === 'Erro') o.s_err++; }
            });
            const filtered = Array.from(map.entries()).filter(([id]) => !analysisEvidences[id]?.completed).map(([id, v]) => {
                let statusParts = [];
                if (v.s_err > 0) statusParts.push("Erro saída"); if (v.e_err > 0) statusParts.push("Erro entrada");
                if (v.s_pend > 0 || v.e_pend > 0) statusParts.push("Pendente");
                const ev = analysisEvidences[id]; const motivoStr = ev ? `${ev.status || ''} - ${ev.note || ''}`.trim() : '';
                return [v.date, id, v.e_ok, v.s_ok, (v.s_ok > 0 && v.e_ok > 0 ? 0 : -1), statusParts.join(" | ") || "Processado", motivoStr];
            });
            const csvHeaders = ["Data", "ID", "Entradas (OK)", "Saidas (OK)", "Diferenca (OK)", "Estado", "Motivo"];
            const csvContent = csvHeaders.join(";") + "\n" + filtered.map(item => item.map(v => `"${String(v).replace(/"/g, '""')}"`).join(";")).join("\n");
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url); link.setAttribute("download", `Divergencias_${new Date().getTime()}.csv`);
            link.click();
            showToast("Exportação concluída!", "success");
        }

        function setupNotesAutoSave() { const f = document.getElementById('notesField'); if (f) f.oninput = () => currentFileName && localStorage.setItem('notes_' + currentFileName, f.value); }
        function loadSavedNotes() { const f = document.getElementById('notesField'); if (f) f.value = localStorage.getItem('notes_' + currentFileName) || ''; }

        async function resetApp() {
            rawData = []; currentFileName = ''; analysisEvidences = {};
            localStorage.removeItem('persist_dateStart'); localStorage.removeItem('persist_dateEnd'); localStorage.removeItem('persist_lineView');
            await removeFromDB('last_raw_data'); await removeFromDB('last_headers'); await removeFromDB('last_filename'); await removeFromDB('last_mapping'); await removeFromDB('analysis_evidences');
            updateAppState(false); if(lineChart) lineChart.destroy(); if(barChart) barChart.destroy(); if(doughnutChart) doughnutChart.destroy();
        }

        function showToast(msg, type = "info") {
            const t = document.getElementById('toast'); if (!t) return;
            t.innerHTML = `<span>${msg}</span>`;
            const bg = type === 'success' ? 'bg-emerald-600' : (type === 'error' ? 'bg-red-600' : 'bg-slate-800');
            t.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-xl text-white text-sm z-50 transition-all duration-300 translate-y-0 opacity-100 ${bg}`;
            setTimeout(() => { t.classList.remove('translate-y-0', 'opacity-100'); t.classList.add('translate-y-24', 'opacity-0'); }, 3000);
        }
    </script>
</body>
</html>
